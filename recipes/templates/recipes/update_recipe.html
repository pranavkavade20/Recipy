{% extends "base.html" %}
{% block title %}Update Recipe | Recipy{% endblock %}

{% block content %}
<main class="min-h-screen py-12 px-4 sm:px-6 lg:px-8 bg-stone-50 dark:bg-gray-950 transition-colors duration-500">
    <div class="max-w-4xl mx-auto">
        
        <div class="mb-10 flex items-center justify-between">
            <div>
                <h2 class="text-3xl md:text-4xl font-extrabold text-gray-900 dark:text-white tracking-tight">
                    Update <span class="text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-600">Recipe</span>
                </h2>
                <p class="text-gray-500 dark:text-gray-400 mt-2">Refine your culinary masterpiece.</p>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-900 shadow-2xl rounded-[2.5rem] p-8 md:p-12 border border-stone-100 dark:border-gray-800">
            
            <form method="post" enctype="multipart/form-data" id="update-form">
                {% csrf_token %}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                    {% for field in recipe_form %}
                    <div class="form-group {% if field.label == 'Receipe description' or field.label == 'Receipe image' or field.name == 'instructions' %}md:col-span-2{% endif %}">
                        <label for="{{ field.id_for_label }}" class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2 uppercase tracking-wide">
                            {{ field.label }}
                        </label>
                        
                        <div class="relative">
                            {{ field }}
                        </div>
                        
                        {% if field.help_text %}
                            <p class="text-xs text-gray-400 mt-2">{{ field.help_text }}</p>
                        {% endif %}
                        {% for error in field.errors %}
                            <p class="text-sm text-red-500 font-bold mt-1 flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                {{ error }}
                            </p>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>

                <div class="border-t border-gray-100 dark:border-gray-800 pt-10">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                        <span class="w-2 h-8 bg-orange-500 rounded-full"></span>
                        Ingredients
                    </h3>
                    
                    <div id="ingredient-form-container" class="space-y-4">
                        {{ ingredient_formset.management_form }}
                        {% for form in ingredient_formset %}
                        <div class="ingredient-field group relative p-5 rounded-2xl bg-stone-50 dark:bg-gray-800/50 border border-stone-200 dark:border-gray-700 transition-all hover:border-orange-200 dark:hover:border-gray-600">
                            
                            <div class="absolute top-2 right-2">
                                {% if form.instance.pk %}
                                    <div class="hidden">{{ form.DELETE }}</div>
                                    <button type="button" class="delete-btn p-2 text-gray-400 hover:text-red-500 transition-colors rounded-full hover:bg-red-50 dark:hover:bg-red-900/20">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                    </button>
                                {% endif %}
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {% for field in form %}
                                    {% if field.label != 'Id' and field.label != 'DELETE' %}
                                    <div class="{% if forloop.counter == 1 %}md:col-span-2{% endif %}"> <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">{{ field.label }}</label>
                                        {{ field }}
                                        {% for error in field.errors %}
                                            <p class="text-xs text-red-500 mt-1">{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    {% if field.label == 'Id' %}{{ field }}{% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <button type="button" id="add-ingredient-button" class="mt-6 flex items-center justify-center w-full md:w-auto px-6 py-3 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-xl text-gray-500 hover:text-orange-600 hover:border-orange-300 hover:bg-orange-50 dark:hover:bg-gray-800 transition-all font-bold text-sm">
                        <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Add Another Ingredient
                    </button>
                </div>

                <div class="flex flex-col-reverse md:flex-row items-center justify-end gap-4 mt-12 pt-8 border-t border-gray-100 dark:border-gray-800">
                    <a href="{% url 'delete_recipe' recipe.id %}" class="w-full md:w-auto px-6 py-3.5 text-red-600 font-bold text-sm hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-colors text-center">
                        Delete Recipe
                    </a>
                    <button type="submit" class="w-full md:w-auto px-8 py-3.5 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold rounded-xl shadow-lg shadow-orange-500/30 transform hover:-translate-y-0.5 transition-all">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. Style Django Inputs Automatically ---
        // This avoids modifying forms.py widgets manually
        const inputs = document.querySelectorAll('input[type="text"], input[type="number"], textarea, select');
        inputs.forEach(input => {
            if (!input.classList.contains('styled-input')) {
                input.classList.add('w-full', 'px-4', 'py-3', 'rounded-xl', 'bg-gray-50', 'dark:bg-gray-800', 'border', 'border-gray-200', 'dark:border-gray-700', 'text-gray-900', 'dark:text-white', 'focus:ring-2', 'focus:ring-orange-500', 'focus:border-transparent', 'transition-all', 'outline-none');
                input.classList.add('styled-input'); // Marker class
            }
        });
        
        const fileInputs = document.querySelectorAll('input[type="file"]');
        fileInputs.forEach(input => {
            input.classList.add('block', 'w-full', 'text-sm', 'text-gray-500', 'file:mr-4', 'file:py-2', 'file:px-4', 'file:rounded-full', 'file:border-0', 'file:text-sm', 'file:font-semibold', 'file:bg-orange-50', 'file:text-orange-700', 'hover:file:bg-orange-100', 'dark:file:bg-orange-900/30', 'dark:file:text-orange-400');
        });

        // --- 2. Custom Delete Button Logic ---
        // Django uses a hidden checkbox for deletion. We use a custom button to toggle it.
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const container = this.closest('.ingredient-field');
                // Find the actual checkbox (usually named ...-DELETE)
                const checkbox = container.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    if(checkbox.checked) {
                        container.classList.add('opacity-50', 'bg-red-50', 'dark:bg-red-900/10');
                        this.classList.add('text-red-600', 'bg-red-100');
                    } else {
                        container.classList.remove('opacity-50', 'bg-red-50', 'dark:bg-red-900/10');
                        this.classList.remove('text-red-600', 'bg-red-100');
                    }
                }
            });
        });

        // --- 3. Dynamic Formset Logic ---
        document.getElementById('add-ingredient-button').addEventListener('click', function() {
            const formContainer = document.getElementById('ingredient-form-container');
            const totalForms = document.getElementById('id_ingredients-TOTAL_FORMS');
            const currentFormCount = parseInt(totalForms.value, 10);
            
            // Clone the last form
            const forms = formContainer.querySelectorAll('.ingredient-field');
            const lastForm = forms[forms.length - 1];
            
            if (!lastForm) return;

            const newForm = lastForm.cloneNode(true);
            const regex = new RegExp(`ingredients-(\\d+)-`, 'g');
            
            newForm.innerHTML = newForm.innerHTML.replace(regex, `ingredients-${currentFormCount}-`);
            
            // Remove the delete button from the new form (it's a new entry, so can't delete from DB yet)
            const delBtn = newForm.querySelector('.delete-btn');
            if(delBtn) delBtn.remove();
            
            // Reset values
            newForm.querySelectorAll('input, select, textarea').forEach(input => {
                if(input.type !== 'hidden') input.value = '';
                input.classList.remove('bg-red-50', 'opacity-50'); // clear delete styling if copied
            });
            newForm.classList.remove('opacity-50', 'bg-red-50', 'dark:bg-red-900/10');

            formContainer.appendChild(newForm);
            totalForms.value = currentFormCount + 1;
        });
    });
</script>
{% endblock %}